<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="css/jquery-ui-1.9.0.custom.min.css">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/chosen.css">
        <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="http://cloud.github.com/downloads/wycats/handlebars.js/handlebars-1.0.0.beta.6.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/chosen.jquery.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.8.24.custom.min.js"></script>

    </head>
    <body>
        <header class="navbar">
            <div class="navbar-inner">
                <div class="container conatiner_support">
                    <div class="float_left">
                        <p id="logo">
                            <a href="http://localhost:8080/FinalDesign/index.html">Site
                                Logo</a> <span class="tagline">Free project hosting</span>
                        </p>
                    </div>
                    <div class="float_right">
                        <ul>
                            <li>
                                <ul class="ul_list" id="nav">
                                    <li><a id="lnkSignUp"> Sign Up</a></li>
                                    <li><a id="lnkSignIn">Sign In</a></li>
                                </ul>
                            </li>
                            <li><input id="searchSite" name="searchSite" maxlength="500"
                                       type="text" value="" autocomplete="off"
                                       title="Search all projects"
                                       style="color: rgb(170, 170, 170); font-style: italic;">
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        <div class="container conatiner_support">
            <div class="row" style="position: relative;">
                <div class="project_head">
                    <div class="project_head_image">
                        <a href="#" >
                            <img src="images/p1.jpg" />
                        </a>
                    </div>
                    <h1 class="project_title">
                        <div>
                            <a href="#">
                                Sample project 
                            </a>
                        </div>
                    </h1>
                </div>
            </div>
        </div>

        <div class="container conatiner_support">
            <div class="row">
                <ul id="project_menu">
                    <li>
                        <a href="" >Home</a>
                    </li>
                    <li>
                        <a href="" >Documentation</a>
                    </li>
                    <li>
                        <a href="" >Bug Tracking</a>
                    </li>
                    <li>
                        <a href="" >Discussion</a>
                    </li>

                </ul>
            </div>
        </div>
        <div class ="conatiner_support container">
            <div class="row">
                <div class="addTask">
                    <a >Add new task</a>
                </div>
            </div>
            <div class="row">
                <div class="tabbable"> 
                    <ul class="nav nav-pills">
                        <li class="active">
                            <a href="#tab1" data-toggle="tab">Todo</a>
                        </li>
                        <li><a href="#tab2" data-toggle="tab">Doing</a></li>
                        <li><a href="#tab3" data-toggle="tab">Done</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab1">
                            <div class="accordion" id="accordion2">

                            </div>
                        </div>
                        <div class="tab-pane" id="tab2">
                            <div class="accordion" id="accordion3">

                            </div>
                        </div>
                        <div class="tab-pane" id="tab3">
                            <div class="accordion" id="accordion4">

                            </div>
                        </div>
                    </div>
                </div>
            </div>           
        </div>
        <div id="dialog_form">
            <div class="row">
                <div id="display"></div>
                <div class="" style="margin-left: 20px;">
                    <label>Task </label>
                    <input type="text" id="txtTaskName"/><br>
                    <label style="float: right;">Members</label>    <label>DeadLine</label>    
                    <input type="text" id="txtDeadLine"/>

                    <select style="float:right;" size="1" id="txtMember" multiple>
                        <option></option>
                    </select>


                    <label>Sub task</label>

                    <div id="subtaskAdd">

                    </div>
                    <div id="subTaskButton">
                        <input type="text" id="txtSubTask" style="display: none;"/>
                        <a id="lblAddSubTask">Add</a>
                        <input type="button" id="btnAddSubTask" value="Add" style="display:none;"/>
                        <a style="display: none;" id="subTaskClose">X</a>
                    </div>
                </div>
                <input type="hidden" id="requestType"/>
            </div>
        </div>
        <div id="footer">
            <div class="row">
                <hr style="color:">
                <ul class="ul_list">
                    <li class="list"></li>
                    <li class="list"><a href="#">Get Help</a></li>
                    <li class="list"><a href="#">Privacy Statement</a></li>
                    <li class="list"><a href="#">Terms of Use</a></li>
                    <li class="list"><a href="#">Code of Conduct</a></li>
                    <li class="list"><a href="#">Advertise With Us</a></li>

                </ul>
            </div>
        </div>
        <input type="hidden" id="hiddenPhase" />
        <input type="hidden" id="hiddenProjId" />
        <script id="templateToDo" type="text/x-handlebars-template">
            {{#each this}}
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-taskId="{{taskId}}" data-parent="#accordion2" href="#select{{taskId}}">
                        {{taskDescription}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        {{deadLine}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

                    </a>

                </div>
                <div id="select{{taskId}}" class="accordion-body collapse">
                    <input type="button" data-taskId="{{taskId}}" value="Remove"/>
                    <div class="accordion-inner">
                        <div class="row">
                            <div class="progress active">
                                <div class="bar" id="progBar{{taskId}}"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div id="left{{taskId}}" style="float: left;padding-left: 25px;"></div>
                            <div id="right{{taskId}}" style="float: right;"></div>
                        </div>
                    </div>
                </div>
            </div>

            {{/each}}
        </script>
        <script id="templateDoing" type="text/x-handlebars-template">
            {{#each this}}
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-taskId="{{taskId}}" data-parent="#accordion2" href="#select{{taskId}}">
                        {{taskDescription}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        {{deadLine}}
                    </a>
                </div>
                <div id="select{{taskId}}" class="accordion-body collapse">

                    <div class="accordion-inner">
                        <div class="row">
                            <div class="progress active">
                                <div class="bar" id="progBar{{taskId}}"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div id="left{{taskId}}" style="float: left;padding-left: 25px;"></div>
                            <div id="right{{taskId}}" style="float: right;"></div>
                        </div>
                    </div>
                </div>
            </div>

            {{/each}}
        </script>
        <script id="templateDone" type="text/x-handlebars-template">
            {{#each this}}
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-taskId="{{taskId}}" data-parent="#accordion2" href="#select{{taskId}}">
                        {{taskDescription}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        {{deadLine}}
                    </a>
                </div>
                <div id="select{{taskId}}" class="accordion-body collapse">

                    <div class="accordion-inner">
                        <div class="row">
                            <div class="progress active">
                                <div id="progBar{{taskId}}" class="bar" ></div>
                            </div>
                        </div>
                        <div class="row">
                            <div id="left{{taskId}}" style="float: left;padding-left: 25px;"></div>
                            <div id="right{{taskId}}" style="float: right;"></div>
                        </div>
                    </div>
                </div>
            </div>

            {{/each}}
        </script>
        <script type="text/javascript">
            (function(){
                var lblAddSubtask=$("#lblAddSubTask");
                var subTaskClose=$("#subTaskClose");
                var txtSubTask=$("#txtSubTask");
                var btnAddSubTask=$("#btnAddSubTask");
                var subtaskAdd=$("#subtaskAdd");
                var members;
                var memberList=$("#txtMember");
                var selectedMember;       
                var task;
                function getParameterByName(name) {
                    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
                    var regexS = "[\\?&]" + name + "=([^&#]*)";
                    var regex = new RegExp(regexS);
                    var results = regex.exec(window.location.search);
                    if (results == null)
                        return "";
                    else
                        return decodeURIComponent(results[1].replace(/\+/g, " "));
                }
                var projId=getParameterByName("projId");
                $('#hiddenProjId').attr('value',projId);
                function fillTask(){
                    $.ajax({
                        url:"ServletShowTask",
                        data: {"projId":projId,
                            "phaseId":1
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            var temp=Handlebars.compile($("#templateToDo").html());
                            $("#accordion2").html(temp(dt.task));
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                    $.ajax({
                        url:"ServletShowTask",
                        data: {"projId":$("#hiddenProjId").attr('value'),
                            "phaseId":2
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            var temp=Handlebars.compile($("#templateDoing").html());
                            $("#accordion3").html(temp(dt.task));
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                    $.ajax({
                        url:"ServletShowTask",
                        data: {"projId":$("#hiddenProjId").attr('value'),
                            "phaseId":3
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            var temp=Handlebars.compile($("#templateDone").html());
                            $("#accordion4").html(temp(dt.task));
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                };
                fillTask();
                function setProgress(taskId){
                    $.ajax({
                        url:'ServletGetTaskProgress',
                        data:{
                            'taskId':taskId
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            console.log(dt);
                            var t='#progBar'+taskId;
                            if (dt.status=='success'){
                                $(t).css('width',dt.prog+'%');
                            }
                        },
                        error:function(){
                            alert('error');
                        }                        
                    });
                }
                $('.accordion-heading a').live('click',function(){
                    var taskId=$(this).attr('data-taskId');
                    task=taskId;
                    var leftTask = '#left' + taskId;
                    var rightTask= '#right' + taskId;
                    var checked
                    //alert(taskId);
                    setProgress(taskId);
                    $.ajax({
                        url:"ServletAddSubtask",
                        data: {
                            "type":'3',
                            "taskId":taskId                            
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            console.log(dt);
                            var str='';
                            $.each(dt.subTask,function(i,val){
                                checked='';
                                //alert(val.status);
                                if (val.status!='Incomplete'){
                                    checked='checked';
                                    //  alert(checked);
                                }
                                str+='<input type="checkbox" data-uId="'+val.uId+'" id="subTask'+val.uId +'" ' + checked + ' />';
                                str+='<span>'+val.subTask+'</span><br>';
                            });
                            $(leftTask).html(str);
                            //alert(str+'  '+leftTask);
                            // var temp=Handlebars.compile($("#templateDone").html());
                            //$("#accordion4").html(temp(dt.task));
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                    $.ajax({
                        url:"ServletGetUser",
                        data: {
                            "type":'2',
                            "taskId":taskId                            
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            var str='';
                            $.each(dt.members,function(i,val){
                                str+='<span>'+val.nick+'</span><br>';
                            });
                            $(rightTask).html(str);
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                });
                $(".accordion-group input:checkbox").live('change',function(){
                    var uId= $(this).attr('data-uId');
                    var cType;
                    var selectCheckbox=this;
                    //alert(uId);
                    if ($(this).attr('checked')=='checked')
                        cType='checked';
                    else
                        cType='unchecked';
                    $.ajax({
                        url:"ServletSubTask",
                        data: {
                            "cType" : cType,
                            "uId" : uId                            
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            if (dt.status!='Success'){
                                if (cType=='checked'){
                                    $(selectCheckbox).attr('checked',false);
                                }
                                else{
                                    $(selectCheckbox).attr('checked',true);
                                }
                            }
                            setProgress(task);
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                });
                $("#dialog_form").dialog(
                {
                    autoOpen : false,
                    height : 600,
                    width : 500,
                    modal : true,
                    buttons : {
                        "Add Task" : function() {
                            var requestType=$("#requestType").attr('value');
                                        
                            $.ajaxSetup({
                                url:"ServletAddSubtask",
                                data: {"type":2, 
                                    "taskName": $("#txtTaskName").attr('value'),
                                    "deadLine": $("#txtDeadLine").attr('value'),
                                    "phaseId":  1,
                                    "projId": $("#hiddenProjId").attr('value'),
                                    "members": selectedMember
                                },
                                type: "POST",
                                success:function(result){
                                    //alert(result.status);
                                    var taskId=result.taskId;
                                    if (result.status.toString()=='Fail'){
                                        $('#display').html('Fail');
                                        return;
                                    }
                                    $("#dialog_form").dialog("close");
                                    fillTask();
                                }
                                
                            }); 
                            $.ajax();
                        },
                        Cancel : function() {
                            $(this).dialog("close");
                        }
                    }
                });
                $("#btnAddSubTask").click(function(){
                    var taskName=$(txtSubTask).attr('value');
                    $(subtaskAdd).append("<input type='checkbox' /><span>"+ taskName + "</span><br>");
                    $(txtSubTask).attr('value','');
                    $(subTaskClose).css('display','none');
                    $(lblAddSubTask).css('display','inline');
                    $(txtSubTask).css('display','none');
                    $(btnAddSubTask).css('display','none');
                    $.ajaxSetup({
                        url:"ServletAddSubtask",
                        data: {
                            "type":1, 
                            "subTask":taskName,
                            "projId":$("#hiddenProjId").attr('value')
                        },
                        type: "POST",
                        success:function(result){
                            $("#diplay").html(result.status);
                        }
                    }); 
                    $.ajax();

                });
                $.ajax({
                    url:"ServletGetUser",
                    data: {
                        "projId":$("#hiddenProjId").attr('value'),
                        "type":'1'
                    },
                    type: "POST",
                    success:function(result){
                        
                        jQuery.each(result, function(index, value) {
                            jQuery.each(value, function(index, val){
                                $(memberList).append('<option value='+val.userId+' id="select'+val.userId+'">'+val.nick+'</option>');
                            });
                        });
                        $('#txtMember').chosen().change(function(e){
                            selectedMember='';
                            var selected=$("#txtMember").children("option").filter(":selected");
                            $.each(selected, function(){
                                selectedMember+=$(this).val()+','+$(this).text()+'---'; 
                            });
                                  
                        });
                    }
                }); 
                $("#lblAddSubTask").click(function(){
                    $(lblAddSubTask).css('display','none');
                    $(txtSubTask).css('display','inline').focus();
                    $(btnAddSubTask).css('display','inline');
                    $(subTaskClose).css('display','inline');
                });
                $("#subTaskClose").click(function(){
                    $(subTaskClose).css('display','none');
                    $(txtSubTask).attr('value','');
                    $(lblAddSubTask).css('display','inline');
                    $(txtSubTask).css('display','none');
                    $(btnAddSubTask).css('display','none');
                    $("#requestType").attr('value','');
                });
                $("#txtDeadLine").datepicker();
                
                $(".addTask a").click(function(){
                    $("#dialog_form").dialog("open");
                });
                $(".accordion-body input:button").live('click',function(){
                    var taskId=$(this).attr('data-taskId');
                    alert(taskId);
                    $.ajax({
                        url:"ServletTask",
                        data: {
                            "taskId" : taskId                            
                        },
                        type: "POST",
                        dataType: 'json',
                        success:function(dt){
                            console.log(dt);
                        },
                        error:function(e){
                            console.log(e)
                        }
                    });
                });
            })();
        </script>   
    </body>
</html>
